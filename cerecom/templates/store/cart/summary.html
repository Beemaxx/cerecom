{% extends "../base.html" %}
{% load static %}
{% load humanize %}
{% block title %}Cart Summary{% endblock %}
{% block content %}

<div class="container my-5">

  <div class="row g-5">
    <div class="col-md">
      <h4 class="d-flex justify-content-between align-items-center mb-3">
        <span class="text-primary">
          <h2>Your Cart</h2>
        </span>
        <!--CART QUANTITY -->
        <span class="badge bg-primary rounded-pill">

          {% with total_qty=cart|length %}
          <div id="cart_quanty" class="d-inline-flex">

            {% if total_qty > 0 %}
            Total Items: {{ total_qty }}
            {% else %}
            0
            {% endif %}
          </div>
          {% endwith %}
        </span>
      </h4>
      <!--END OF CART QUANTITY -->

      <!-- TABLE -->
      <table class="table table-hover">
        <thead>
          <tr>
            <th scope="col" class="">No</th>
            <th scope="col" class="text-start">Name</th>
            <th scope="col" class="text-center">Image</th>
            <th scope="col" class="">Price</th>
            <th scope="col" class="text-center">Quantity</th>
            <th scope="col" class="text-center">Delete</th>
            <th scope="col" class="text-end">Total(VND)</th>
          </tr>
        </thead>
        <tbody>
          {% for item in cart_items %}
          <div>
            <tr class="cart-items align-middle" data-index="{{item.product.id}}">
              <th scope="row" class=""> {{ forloop.counter }} </th>
              <!-- Item Url -->

              <td>
                {{ item.product.name }}<br>
                <a href="{{ item.product.get_absolute_url }}">View more </a>

              </td>
              <!-- Item Image -->
              <td class="text-center">
                <img class="img-thumbnail" src={{ item.product.image.url }} style="width:auto ; height:100px">
              </td>
              <!-- Item Unit Price  & Promotion price -->
              <td><s><small>{{ item.product.price|floatformat:"0"  }} VND</s></small>
                <br>
                Discounted Price:
                <br>
                {{ item.product.get_product_promotion_price|floatformat:"0"  }} VND
              </td>

              <td class="text-center">
                <!-- QUANTITY BUTTON-->



                <!-- ITEM INCREASE BUTTON-->

                <button data-index="{{item.product.id}}" class="item-increase-button btn btn-none" type="button">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                    class="bi bi-caret-up" viewBox="0 0 16 16">
                    <path
                      d="M3.204 11h9.592L8 5.519 3.204 11zm-.753-.659 4.796-5.48a1 1 0 0 1 1.506 0l4.796 5.48c.566.647.106 1.659-.753 1.659H3.204a1 1 0 0 1-.753-1.659z" />
                  </svg>
                </button>
                <!-- quantity data -->
                <span class="item-quantity" data-index="{{item.qty}}"> {{ item.qty }} </span>
                <!-- ITEM DECREASE BUTTON-->
                <button data-index="{{item.product.id}}" class="item-decrease-button btn btn-none" type="button">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                    class="bi bi-caret-down" viewBox="0 0 16 16">
                    <path
                      d="M3.204 5h9.592L8 10.481 3.204 5zm-.753.659 4.796 5.48a1 1 0 0 0 1.506 0l4.796-5.48c.566-.647.106-1.659-.753-1.659H3.204a1 1 0 0 0-.753 1.659z" />
                  </svg>
                </button>

                <!-- END OF QUANTITY BUTTON-->

                <!-- DELETE BUTTON-->
              <td class="text-center">
                <button id="delete-button" data-index="{{item.product.id}}"
                  class="delete-button btn btn-outline-none mx-1" type="button">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash"
                    viewBox="0 0 16 16">
                    <path
                      d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z" />
                    <path fill-rule="evenodd"
                      d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z" />
                  </svg>
                </button>
              </td>
              <!-- END OF DELETE BUTTON-->
              <!-- total cost-->
              </td>
              <td class="text-end">
                {{ item.total_price }} VND
              </td>

              <!-- END OF PRICE -->
            </tr>



          </div>
          {% endfor %}
          <tr>
          </tr>
        </tbody>
        <tfoot>
          {% comment %} <tr>
            <td colspan="6">
              <div class="input-group">
                <input type="text" class="form-control" placeholder="Promo code">
                <button type="submit" class="btn btn-secondary">Redeem</button>
              </div>
            </td>
          </tr> {% endcomment %}

          <!-- Total Cost -->
          <tr>
            <td colspan="6">
              <b>Total (VND)</b>
            </td>
            <td class="text-end">
              {{ cart.get_total_order }} VND
            </td>
          </tr>
          <!-- END OF TOTAL ROW-->


          <!-- Total Promotion -->
          <tr>
            <td colspan="6">
              <b>Promotion {{ item.product.slug  }}</b>

            </td>
            <td class="text-end table-success">
              - {{ cart.discount_amount }} VND
            </td>
          </tr>
          <!-- END OF Promotion-->

          <!-- Total Shipping Method -->
          <tr>
            <td colspan="6">
              <b>Order Cost (VND)</b>
            </td>
            <td class="text-end">
              {{ cart.get_total_price | intcomma }} VND
            </td>
          </tr>
          <tr>
            <td colspan="6" class="d-flex-inline">
              <b>Shipping Method</b>

                   
                  <select id="shipping_cost" class="mx-3 " onChange="update_shipping_cost()">
                    <option value="0">Pick up at store</option>
                    <option value="20000">Inside Ecopark</option>
                    <option value="50000">Outside Ecopark</option>
                  </select>
      
            </td>
            <td class="text-end">
              <text id='shipping_actual_cost' class="text-end border border-0" disabled> VND</text>
            </td>
          </tr>
          <!-- END OF Shipping Method-->

          <!-- Total Final Cost -->
          <tr>
            <td colspan="6">
              <b>Final Cost (VND)</b>
            </td>
            {% comment %} <td class="text-end bg-success text-white" id="final_cost">
               VND
            </td> {% endcomment %}
            <td id="final_cost" class="text-end table-warning border border-0" disabled> 
            </td>
          </tr>
          <!-- END OF Final Cost-->
        </tfoot>

      </table>

      <!-- Checkout Button -->
      {% with total_qty=cart|length %}
      <div id="cart_quanty" class="d-flex justify-content-end">

        {% if total_qty > 0 %}
        <div class"col-md-5 col-lg-4 order-md-last p-0 order-3">
          <div class="gap-2 ">
            <a role="button" href="{% url 'payment:home' %}" class="btn btn-outline-success mx-2 px-2" type="button"
              style="width:200px">Checkout</a>
            <button class="btn btn-light mx-2 px-2" type="button" style="width:200px">Save for later</button>
          </div>
        </div>
        {% else %}

        <div clas=s"col-md-5 col-lg-4 order-md-last p-0 order-3">
          <div class="gap-2">
            There is no items in your cart.
            Go to <a href={% url 'store:all_products' %}>homepage</a> to shop.
          </div>
        </div>
        {% endif %}
        {% endwith %}
        
      </div>





      <script>
        $(document).on('click', '.delete-button', function (e) {
          e.preventDefault();
          var proid = $(this).data('index');

          $.ajax({
            type: 'POST',
            url: '{% url "cart:cart_delete" %}',
            data: {
              productid: $(this).data('index'),
              csrfmiddlewaretoken: "{{csrf_token}}",
              action: 'delete',
            },

            success: function (json) {
              console.log(proid)
              $('.cart-items[data-index="' + proid + '"]').remove();
              location.reload();
              document.getElementById("cart_quanty").innerHTML = json.qty;
            },
            error: function (xhr, errmsg, err) {}
          })
        })


        $(document).on('click', '.item-increase-button', function (e) {
          e.preventDefault();
          var proid = $(this).data('index');

          $.ajax({
            type: 'POST',
            url: '{% url "cart:item_increase" %}',
            data: {
              productid: $(this).data('index'),
              productqty: $('.item-quantity').data('index'),
              csrfmiddlewaretoken: "{{csrf_token}}",
              action: 'item_increase',
            },

            success: function (json) {
              console.log(proid)
              $('.cart-items[data-index="' + proid + '"]').remove();
              document.getElementById("cart_quanty").innerHTML = json.qty;

              location.reload();

            },
            error: function (xhr, errmsg, err) {}
          })
        })


        $(document).on('click', '.item-decrease-button', function (e) {
          e.preventDefault();
          var proid = $(this).data('index');

          $.ajax({
            type: 'POST',
            url: '{% url "cart:item_decrease" %}',
            data: {
              productid: $(this).data('index'),
              productqty: $('.item-quantity').data('index'),
              csrfmiddlewaretoken: "{{csrf_token}}",
              action: 'item_decrease',
            },

            success: function (json) {
              console.log(proid)
              $('.cart-items[data-index="' + proid + '"]').remove();
              document.getElementById("cart_quanty").innerHTML = json.qty;

              location.reload();

            },
            error: function (xhr, errmsg, err) {}
          })
        })
      </script>

    </div>
  </div>
</div>

<!-- Update shipping cost based on option-->
<script type="text/javascript">
  function update_shipping_cost(){
    var shipping_option = document.getElementById('shipping_cost');
    var shipping_cost = shipping_option.options[shipping_option.selectedIndex];
    var y = parseInt(shipping_cost.value);
    console.log(y.toLocaleString())
    document.getElementById('shipping_actual_cost').innerHTML = y.toLocaleString() + ' VND';
    
  }
 update_shipping_cost();

</script> 


<script>
  $('#shipping_cost').on('change', function (e) {
    e.preventDefault();
    var shipping_cost = $('#shipping_cost').find(":selected").val();
    $.ajax({
      type: 'POST',
      url: '{% url "cart:add_shipping_cost" %}',
      data: {
        csrfmiddlewaretoken: "{{csrf_token}}",
        shipping_cost: shipping_cost,
        action: 'add_shipping_cost',
      },

      success: function (json) {
      
      document.getElementById("final_cost").innerHTML = json.final_cost.toLocaleString() + ' VND';
      },
      error: function (xhr, errmsg, err) {}
    })
  })
</script>


{% endblock %}